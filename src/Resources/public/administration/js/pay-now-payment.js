(this.webpackJsonp=this.webpackJsonp||[]).push([["pay-now-payment"],{"58qF":function(e,n){e.exports='{% block sw_order_list_grid_columns_order_number %}\n    {% parent %}\n<template #column-orderRefund="{ item }" >\n    <span v-if="item.customFields && item.customFields.refoundAmount">\n        {{ item.customFields.refoundAmount}} {{ item.currency.symbol }}\n    </span>\n</template>\n{% endblock %}\n'},"BQA/":function(e,n){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,n){return(o=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function a(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=s(e);if(n){var o=s(this).constructor;t=Reflect.construct(r,arguments,o)}else t=r.apply(this,arguments);return i(this,t)}}function i(e,n){return!n||"object"!==t(n)&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var d=Shopware.Application,c=function(e){!function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&o(e,n)}(d,e);var n,t,i,s=a(d);function d(e,n){return function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,d),s.call(this,e,n)}return n=d,(t=[{key:"testApi",value:function(){return this.httpClient.post("/paynowpayment/test-api",{},{headers:this.getBasicHeaders()})}},{key:"refundPayment",value:function(e,n,t,r){return this.httpClient.post("/paynowpayment/refund-payment",{orderId:e,amountToRefund:n,descriptionOfRefund:t,productsToRefund:r},{headers:this.getBasicHeaders()})}},{key:"fetchStatus",value:function(e){return this.httpClient.post("/paynowpayment/fetch-refund-payment",{refundId:e},{headers:this.getBasicHeaders()})}}])&&r(n.prototype,t),i&&r(n,i),d}(Shopware.Classes.ApiService);d.addServiceProvider("PayNowOrderService",(function(e){var n=d.getContainer("init");return new c(n.httpClient,e.loginService)}))},FZHo:function(e,n,t){var r=t("cvio");"string"==typeof r&&(r=[[e.i,r,""]]),r.locals&&(e.exports=r.locals);(0,t("SZ7m").default)("849a6a90",r,!0,{})},cZEs:function(e,n,t){},cvio:function(e,n,t){},"d0z+":function(e,n,t){"use strict";t.r(n);var r=t("x+Lp"),o=t.n(r),a=(t("FZHo"),Shopware),i=a.Component,s=a.Context,d=Shopware.Data.Criteria;i.override("sw-order-detail",{template:o.a,data:function(){return{isLoadingPayNowTransactions:!0,payNowTransactions:[],hasIncompleteTransaction:!1}},computed:{showTabs:function(){return!0}},watch:{orderId:{deep:!0,handler:function(){this.loadPayNowTransactions(this.orderId)},immediate:!0}},methods:{loadPayNowTransactions:function(e){var n=this;if(e){this.isLoadingPayNowTransactions=!0;var t=this.repositoryFactory.create("order"),r=new d(1,1);r.addAssociation("transactions"),r.addFilter(d.equals("id",e)),t.search(r,s.api).then((function(e){var t=e.first();t&&(n.identifier||(n.identifier=t.orderNumber),t.transactions.forEach((function(e){n.payNowTransactions.push(e)})))})).finally((function(){n.isLoadingPayNowTransactions=!1}))}else this.isLoadingPayNowTransactions=!1},getPayNowDetailsRoute:function(e){return{name:"pay-now-order.payment.detail",params:{id:this.$route.params.id,transactionId:e}}}}});var c=t("58qF"),u=t.n(c);Shopware.Component.override("sw-order-list",{template:u.a,methods:{getOrderColumns:function(){var e=this.$super("getOrderColumns");return e.splice(5,0,{property:"orderRefund",label:this.$tc("pay-now-order.general.orderListLabel"),align:"right",allowResize:!0}),e}}});var l=t("tpss"),p=t.n(l);t("xA5V");function f(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null==t)return;var r,o,a=[],i=!0,s=!1;try{for(t=t.call(e);!(i=(r=t.next()).done)&&(a.push(r.value),!n||a.length!==n);i=!0);}catch(e){s=!0,o=e}finally{try{i||null==t.return||t.return()}finally{if(s)throw o}}return a}(e,n)||function(e,n){if(!e)return;if("string"==typeof e)return y(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);"Object"===t&&e.constructor&&(t=e.constructor.name);if("Map"===t||"Set"===t)return Array.from(e);if("Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return y(e,n)}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}var w=Shopware,m=w.Component,h=w.Mixin,v=w.Context,b=Shopware.Data.Criteria;m.register("pay-now-order-tab",{template:p.a,inject:["PayNowOrderService","repositoryFactory"],mixins:[h.getByName("notification"),h.getByName("sw-inline-snippet")],data:function(){return{showPayNowTab:!1,refundAmountTooBig:!1,refundAmountTooSmall:!1,refundError:!1,refundOk:!1,refundRejected:!1,succesfulProductsList:[],currency:null,listofPaymentsIdToFetch:[],listOfAmounts:[],refundStatus:null,refundPending:!1,order:null,orderItems:[],orderTransactionIds:[],orderTransactionArray:[],payNowHistory:[],isLoading:!0,isSuccess:!0,transaction:null,refreshTime:5e3,refreshing:!1,refreshHandler:null,amountToRefund:0,descriptionToRefund:"OTHER",checkedProduct:null,modalMode:!1,orderLineItems:[],productsToRefund:[],refundReasons:[{value:"RMA",labelProperty:"reklamacja"},{value:"REFUND_BEFORE_14",labelProperty:"zwrot poniżej 14 dni od zakupu"},{value:"REFUND_AFTER_14",labelProperty:"zwrot powyżej 14 dni od zakupu"},{value:"OTHER",labelProperty:"inny powód"}]}},computed:{orderRepository:function(){return this.repositoryFactory.create("order")},transactionRepository:function(){return this.repositoryFactory.create("order_transaction")},payNowRefundRepository:function(){return this.repositoryFactory.create("paynow_refund_history")},columns:function(){return[{property:"input",label:"Do zwrotu",rawData:!0},{property:"quantity",label:"Ilość",rawData:!0},{property:"refundedQty",label:"Zwrócono",rawData:!0},{property:"label",label:"Nazwa",rawData:!0},{property:"unitPrice",label:"Cena/sztukę",rawData:!0},{property:"totalPrice",label:"Cena/całość",rawData:!0}]},columnsHistory:function(){return[{property:"paynowStatus",label:"Status",rawData:!0},{property:"refundAmount",label:"Ilość",rawData:!0},{property:"refundId",label:"PayNow ID",rawData:!0},{property:"createdAt",label:"Data utworzenia",rawData:!0}]},columnsHistoryProduct:function(){return[{property:"qty",label:"Ilość"},{property:"label",label:"Nazwa"}]},billingAddress:function(){var e=this.order.billingAddressId;return this.order.addresses.get(e)},shippingAddress:function(){return this.order.deliveries.last().shippingOrderAddress}},watch:{$route:function(){this.resetDataAttributes(),this.createdComponent()}},created:function(){this.createdComponent()},methods:{modalModeFalse:function(){this.modalMode=!1},calculateRefund:function(){var e=this;this.amountToRefund=0,this.productsToRefund=[],this.orderItems.forEach((function(n){if(n.toRefund>n.quantity)return n.toRefund=0,alert(e.$tc("pay-now-order.notification.alert"));e.amountToRefund+=n.toRefund*n.unitPrice,e.productsToRefund.push({id:n.id,refundedQty:n.toRefund})}))},refreshDataSource:function(){var e=this;this.payNowHistory=[],this.listOfAmounts=[],this.listOfAmounts.push(this.order.price.totalPrice);var n=[];this.orderTransactionIds.forEach((function(t){n.push(e.loadPayNowHistory(t))})),Promise.all(n).then((function(n){n.forEach((function(n){n.forEach((function(n){var t=n.createdAt.slice(0,10)+" "+n.createdAt.slice(11,19);e.payNowHistory.push({id:n.id,paynowStatus:n.paynowStatus,refundAmount:n.refundAmount,refundId:n.refundId,productList:n.productList,createdAt:t}),"zwrot zaakceptowany"===n.paynowStatus&&(n.productList.forEach((function(n){e.succesfulProductsList.push({id:Object.keys(n)[0],qty:parseInt(Object.values(n)[0])})})),e.listOfAmounts.push(n.refundAmount))}))})),e.compareLineItems()}))},dataSource:function(){var e=this;this.order.lineItems.forEach((function(n){return e.orderItems.push({id:n.id,quantity:n.quantity,refundedQty:0,label:n.label,unitPrice:n.price.unitPrice,totalPrice:n.price.totalPrice,toRefund:0})})),this.order.deliveries.forEach((function(n){n.shippingCosts.totalPrice&&e.orderItems.push({id:n.id,quantity:1,refundedQty:0,label:n.shippingMethod.name,unitPrice:n.shippingCosts.totalPrice,totalPrice:n.shippingCosts.totalPrice,toRefund:0})})),this.order.transactions.forEach((function(n){return e.orderTransactionIds.push(n.id)}));var n=[];this.orderTransactionIds.forEach((function(t){n.push(e.loadPayNowHistory(t))})),Promise.all(n).then((function(n){n.forEach((function(n){n.forEach((function(n){var t=n.createdAt.slice(0,10)+" "+n.createdAt.slice(11,19);e.payNowHistory.push({id:n.id,paynowStatus:n.paynowStatus,refundAmount:n.refundAmount,refundId:n.refundId,productList:n.productList,createdAt:t}),"zwrot zaakceptowany"===n.paynowStatus?(n.productList.forEach((function(n){e.succesfulProductsList.push({id:Object.keys(n)[0],qty:parseInt(Object.values(n)[0])})})),e.listOfAmounts.push(n.refundAmount)):e.listofPaymentsIdToFetch.push(n.refundId)}))})),e.compareLineItems(),e.fetchStatus(),e.groupProducts(),e.prepareRefoundedProducts()}))},groupProducts:function(){var e=this.succesfulProductsList.reduce((function(e,n){return e.set(n.id,(e.get(n.id)||0)+Number(n.qty))}),new Map);this.succesfulProductsList=Array.from(e,(function(e){var n=f(e,2);return{id:n[0],qty:n[1]}}))},prepareRefoundedProducts:function(){var e=this;this.orderItems.forEach((function(n,t){e.succesfulProductsList.forEach((function(e){n.id===e.id&&(n.refundedQty=e.qty)}))}))},compareLineItems:function(){var e=this;this.payNowHistory.forEach((function(e){e.productsToPass=[]})),this.payNowHistory.forEach((function(n,t){n.productList.forEach((function(t){var r=Object.keys(t)[0],o=Object.values(t)[0];e.orderItems.forEach((function(e){e.id===r&&n.productsToPass.push({qty:o,label:e.label})}))}))}))},loadPayNowHistory:function(e){var n=new b(1,25);return n.addFilter(b.equals("transactionId",e)),this.payNowRefundRepository.search(n,v.api)},createdComponent:function(){this.loadData()},doRefund:function(){var e=this,n=this;this.amountToRefund>this.order.amountTotal?this.refundAmountTooBig=!0:this.amountToRefund<1?this.refundAmountTooSmall=!0:this.PayNowOrderService.refundPayment(this.order.id,this.amountToRefund.toFixed(2),this.descriptionToRefund,this.productsToRefund).then((function(){e.createNotificationSuccess({title:"Succes",message:e.$tc("pay-now-order.notification.success")}),n.modalModeFalse()})).catch((function(){e.createNotificationError({title:"Error",message:e.$tc("pay-now-order.notification.failure")})}))},fetchStatus:function(){var e=this,n=[];this.listofPaymentsIdToFetch.forEach((function(t){n.push(e.PayNowOrderService.fetchStatus(t))})),Promise.all(n).then((function(n){e.refreshDataSource()}))},loadData:function(){var e=this,n=this.$route.params.id;this.loadOrder(n).then((function(n){e.order=n,e.isLoading=!1,e.listOfAmounts.push(n.price.totalPrice),e.currency=n.currency.symbol,e.dataSource(),null!==n.transactions[0].customFields&&null!==n.transactions[0].customFields.paynowPaymentId&&(e.showPayNowTab=!0),e.isLoading=!1}))},loadOrder:function(e){var n=new b(1,1);return n.addAssociation("addresses"),n.addAssociation("currency"),n.addAssociation("deliveries"),n.addAssociation("deliveries.shippingMethod"),n.addAssociation("transactions"),n.addAssociation("lineItems"),n.addAssociation("orderCustomer"),this.orderRepository.get(e,v.api,n)}}}),Shopware.Module.register("pay-now-order",{type:"plugin",name:"PayNowOrder",title:"pay-now-order.general.title",description:"pay-now-order.general.description",version:"1.0.0",targetVersion:"1.0.0",routeMiddleware:function(e,n){"sw.order.detail"===n.name&&n.children.push({component:"pay-now-order-tab",name:"pay-now-order.payment.detail",isChildren:!0,path:"/sw/order/pay-now-order/detail/:id/:transactionId"}),e(n)}});t("BQA/");var g=t("yLSd"),P=t.n(g);function A(e,n,t,r,o,a,i){try{var s=e[a](i),d=s.value}catch(e){return void t(e)}s.done?n(d):Promise.resolve(d).then(r,o)}var S=Shopware,T=S.Component,R=S.Mixin;T.register("paynow-settings",{template:P.a,inject:["PayNowOrderService","systemConfigApiService"],mixins:[R.getByName("notification")],data:function(){return{isLoading:!1}},created:function(){var e;"PayNowPayment"===document.documentURI.split("/").pop()&&(e="English"===Shopware.Context.api.language.name?"paynow configuration":"paynow konfiguracja",document.getElementsByClassName("sw-meteor-page__smart-bar-title")[0].innerText=e)},methods:{onTestCredentials:function(){var e,n=this;return(e=regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,n.PayNowOrderService.testApi();case 3:t=e.sent,console.log(t),n.createNotificationSuccess({title:"Success",message:n.$tc("pay-now-order.notification.testSucces")}),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.createNotificationError({title:"Error",message:n.$tc("pay-now-order.notification.testError")});case 11:case"end":return e.stop()}}),e,null,[[0,8]])})),function(){var n=this,t=arguments;return new Promise((function(r,o){var a=e.apply(n,t);function i(e){A(a,r,o,i,s,"next",e)}function s(e){A(a,r,o,i,s,"throw",e)}i(void 0)}))})()}}})},tpss:function(e,n){e.exports='{% block  pay_now_order_payment_page %}\n<div v-if="!isLoading" class="">\n    <div v-if="showPayNowTab">\n        <sw-card rows="6"\n                 :title="$tc(\'pay-now-order.general.description\')"\n                 :large="false"\n                 :isLoading="isLoading"\n                 class="sw-order-user-card"\n        >\n            <sw-container columns="1fr 1fr" class="pay-now-header">\n\n                <div>\n                    <img class="pay-now-logo" :src="\'paynowpayment/static/img/logo_paynow.png\'|asset">\n                </div>\n                <div class="sw-order-user-card__info-summary" v-if="!isLoading">\n                    <div v-for="elements in listOfAmounts" class="pay-now-list-of-elements sw-order-user-card__metadata-price">\n                        {{ elements }} {{ currency }}\n                    </div>\n                </div>\n\n            </sw-container>\n            <sw-container class="pay-now-refund-button">\n                <div>\n                    <sw-button-group>\n                        <sw-button  variant="primary"size="small" @click="modalMode=true" class="">\n                            {{ $tc(\'pay-now-order.buttons.buttonPrepareRefund\') }}\n                        </sw-button>\n                    </sw-button-group>\n                </div>\n\n            </sw-container>\n\n\n            <sw-container class="pay-now-overview">\n                <dl class="sw-description-list sw-order-user-card__summary-vertical">\n                    <dt>{{ $tc(\'pay-now-order.general.overviewLabelPaynowID\') }}</dt>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ order.transactions[0].customFields[\'paynowPaymentId\'] }}\n                        </div>\n                    </dd>\n                </dl>\n                <dl class="sw-description-list sw-order-user-card__summary-vertical">\n                    <dt> {{ $tc(\'pay-now-order.general.overviewLabelPaynowStatus\') }}</dt>\n                    <dd>\n                        <div class="sw-order-inline-field">paid</div>\n                    </dd>\n                </dl>\n            </sw-container>\n\n            <sw-container class="pay-now-overview">\n\n                <dl class="sw-description-list sw-order-user-card__summary-vertical">\n                    <dt> {{ $tc(\'pay-now-order.general.overviewLabelPaynowPaymentAddress\') }}</dt>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ billingAddress.firstName }} {{ billingAddress.lastName }}</div>\n                    </dd>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ billingAddress.street }}</div>\n                    </dd>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ billingAddress.city }} {{ billingAddress.zipcode }}</div>\n                    </dd>\n                </dl>\n\n                <dl class="sw-description-list sw-order-user-card__summary-vertical">\n                    <dt> {{ $tc(\'pay-now-order.general.overviewLabelPaynowDeliveryAddress\') }}</dt>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ shippingAddress.firstName }} {{ shippingAddress.lastName }}</div>\n                    </dd>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ shippingAddress.street }}</div>\n                    </dd>\n                    <dd>\n                        <div class="sw-order-inline-field">{{ shippingAddress.city }} {{ shippingAddress.zipcode }}</div>\n                    </dd>\n                </dl>\n\n            </sw-container>\n\n            <sw-data-grid :isLoading="isLoading"\n                          :showActions="false"\n                          :showSelection="false"\n                          :dataSource="payNowHistory"\n                          :columns="columnsHistory"\n                          class="pay-now-data-grid"\n            >\n                <template #column-productsToPass="{ item, itemIndex }">\n\n                    <sw-data-grid :dataSource="item.productsToPass"\n                                  :showActions="false"\n                                  :columns="columnsHistoryProduct"\n                                  :showSelection="false">\n                    </sw-data-grid>\n                </template>\n            </sw-data-grid>\n\n            <div order="order">\n                <sw-modal v-if="modalMode" @modal-close="modalModeFalse" title="paynow zwroty"\n                          selector=".example .panel--content" class="pay-now-modal">\n\n                    <sw-data-grid :showActions="false" :showSelection="false" :dataSource="orderItems" :columns="columns">\n                        <template #column-input="{ item, itemIndex }">\n\n                            <sw-number-field @change="calculateRefund" v-model="item.toRefund" numberType="int" :step="null"\n                                             :min="0" :max="item.quantity" :allowEmpty="true">\n                                0\n                            </sw-number-field>\n\n                        </template>\n                    </sw-data-grid>\n                    <div  v-if="refundError">\n                        <sw-alert variant="warning"\n                                  :closable="true">\n                            <p>{{ $tc(\'pay-now-order.errors.refusedRefund\') }}</p>\n                        </sw-alert>\n                    </div>\n                    <div  v-if="refundAmountTooBig">\n                        <sw-alert variant="warning"\n                                  :closable="true">\n                            <p>{{ $tc(\'pay-now-order.errors.toMuch\') }}</p>\n                        </sw-alert>\n                    </div>\n                    <div  v-if="refundAmountTooSmall">\n                        <sw-alert variant="warning"\n                                  :closable="true">\n                            <p>{{ $tc(\'pay-now-order.errors.minimalAmount\') }}</p>\n                        </sw-alert>\n                    </div>\n                    <div>\n                        {{ $tc(\'pay-now-order.modal.refundAmount\') }}\n                    </div>\n                    <sw-number-field v-model="amountToRefund" numberType="float" min=0 :allowEmpty="false">\n\n                    </sw-number-field>\n\n                    <div>\n                        {{ $tc(\'pay-now-order.modal.refundDescription\') }}\n                    </div>\n                    <div>\n                        <sw-single-select\n                                labelProperty="labelProperty"\n                                valueProperty="value"\n                                v-model="descriptionToRefund"\n                                :options="refundReasons"/>\n                    </div>\n                    <sw-button variant="primary"\n                               size="small"\n                               :isLoading="isLoading"\n                               @click="doRefund">\n                        {{ $tc(\'pay-now-order.buttons.buttonRefund\') }}\n                    </sw-button>\n                </sw-modal>\n            </div>\n        </sw-card>\n    </div>\n    <div v-else>\n        <sw-card>\n            {{ $tc(\'pay-now-order.general.differentPaymentMethod\') }}\n        </sw-card>\n    </div>\n</div>\n{% endblock %}\n'},"x+Lp":function(e,n){e.exports='{% block sw_order_detail_content_tabs_general %}\n    {% parent %}\n\n    {% block pay_now_order_payment_tab %}\n<template v-if="!isLoadingPayNowTransactions">\n    <sw-tabs-item v-for="payNowTransaction in payNowTransactions"\n                  v-bind:key="payNowTransaction.id"\n                  :route="getPayNowDetailsRoute(payNowTransaction.id)"\n                  :title="$tc(\'pay-now-order.general.description\')">\n        {{ $tc(\'pay-now-order.general.title\') }}\n    </sw-tabs-item>\n</template>\n{% endblock %}\n{% endblock %}\n\n{% block sw_order_detail_content_view %}\n<sw-container v-if="hasIncompleteTransaction" columns="1fr" class="pay-now-order-notification-container">\n    <sw-alert variant="warning" appearance="default" :showIcon="true" :closable="false">\n        {{ $tc(\'pay-now-order.notification.invalidTransaction\') }}\n    </sw-alert>\n</sw-container>\n\n{% parent %}\n{% endblock %}\n\n\n'},xA5V:function(e,n,t){var r=t("cZEs");"string"==typeof r&&(r=[[e.i,r,""]]),r.locals&&(e.exports=r.locals);(0,t("SZ7m").default)("5279f1a3",r,!0,{})},yLSd:function(e,n){e.exports='<div>\n    <sw-button :disabled="false" variant="primary" :square="false" :block="false" :isLoading="isLoading" @click="onTestCredentials">\n        TEST API\n    </sw-button>\n\n</div>'}},[["d0z+","runtime","vendors-node"]]]);